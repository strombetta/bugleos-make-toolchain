name: Tag from VERSION

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump (none keeps current version)"
        required: true
        default: none
        type: choice
        options: [none, patch, minor, major]
      prerelease:
        description: "Optional prerelease identifier (e.g., rc.1)"
        required: false
        default: ''
        type: string

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Read and optionally bump VERSION
        id: version
        env:
          BUMP: ${{ github.event.inputs.bump }}
          PRERELEASE: ${{ github.event.inputs.prerelease }}
        run: |
          set -euo pipefail
          if [ ! -f VERSION ]; then
            echo "VERSION file is missing. Please add VERSION with MAJOR.MINOR.PATCH." >&2
            exit 1
          fi
          current_version=$(cat VERSION | tr -d '\n')
          if [[ ! "$current_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "VERSION must be in MAJOR.MINOR.PATCH format" >&2
            exit 1
          fi

          IFS='.' read -r major minor patch <<<"$current_version"
          case "$BUMP" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            none)
              ;;
            *)
              echo "Invalid bump value: $BUMP" >&2
              exit 1
              ;;
          esac

          new_version="$major.$minor.$patch"
          if [ "$new_version" != "$current_version" ]; then
            echo "$new_version" > VERSION
            echo "version_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "version_changed=false" >> "$GITHUB_OUTPUT"
          fi

          final_version="$new_version"
          if [ -n "$PRERELEASE" ]; then
            final_version+="-$PRERELEASE"
          fi

          echo "final_version=$final_version" >> "$GITHUB_OUTPUT"
          echo "tag=v$final_version" >> "$GITHUB_OUTPUT"

      - name: Commit VERSION update
        if: steps.version.outputs.version_changed == 'true'
        env:
          FINAL_VERSION: ${{ steps.version.outputs.final_version }}
        run: |
          set -euo pipefail
          git add VERSION
          git commit -m "Bump VERSION to ${FINAL_VERSION}"

      - name: Ensure tag does not exist
        run: |
          set -euo pipefail
          tag_name="${{ steps.version.outputs.tag }}"
          if git rev-parse "$tag_name" >/dev/null 2>&1; then
            echo "Tag $tag_name already exists" >&2
            exit 1
          fi

      - name: Push changes and create tag
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          tag_name="${{ steps.version.outputs.tag }}"
          final_version="${{ steps.version.outputs.final_version }}"
          if [ "${{ steps.version.outputs.version_changed }}" = "true" ]; then
            branch="${GITHUB_REF_NAME:-${DEFAULT_BRANCH}}"
            if [ -z "$branch" ]; then
              echo "Unable to determine branch for pushing VERSION update" >&2
              exit 1
            fi
            git push origin "HEAD:${branch}"
          fi
          git tag -a "$tag_name" -m "BugleOS Toolchain v${final_version}"
          git push origin "$tag_name"

      - name: Display final version
        run: |
          echo "Version: ${{ steps.version.outputs.final_version }}"
          echo "Tag: ${{ steps.version.outputs.tag }}"
